<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tech Digest - Python Edition</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üì∞</text></svg>">
    <style>
        :root {
            --primary: #3b82f6;
            --primary-dark: #2563eb;
            --background: #ffffff;
            --foreground: #1e293b;
            --muted: #64748b;
            --border: #e2e8f0;
            --destructive: #ef4444;
            --success: #10b981;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(to bottom right, #f8fafc 0%, #e2e8f0 100%);
            min-height: 100vh;
            color: var(--foreground);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            background: var(--background);
            border-radius: 16px;
            padding: 24px 32px;
            margin-bottom: 32px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }

        .header-left {
            flex: 1;
            min-width: 200px;
        }

        .header-title {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .header-title h1 {
            font-size: 32px;
            color: var(--foreground);
            font-weight: 700;
        }

        .subtitle {
            color: var(--muted);
            font-size: 14px;
        }

        .header-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .btn:hover:not(:disabled) {
            background: var(--primary-dark);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: white;
            color: var(--primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: #f8fafc;
        }

        .btn-ghost {
            background: transparent;
            color: var(--muted);
        }

        .btn-ghost:hover {
            background: #f8fafc;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 13px;
        }

        /* Info Bar */
        .info-bar {
            background: white;
            border-radius: 12px;
            padding: 16px 24px;
            margin-bottom: 24px;
            text-align: center;
            font-size: 14px;
            color: var(--muted);
        }

        .info-bar strong {
            color: var(--foreground);
            font-weight: 600;
        }

        /* Articles Grid */
        .articles-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .article-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: all 0.2s;
            cursor: pointer;
            display: flex;
            flex-direction: column;
        }

        .article-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .article-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            background: linear-gradient(135deg, var(--primary) 0%, #8b5cf6 100%);
        }

        .article-content {
            padding: 20px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .article-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--foreground);
            margin-bottom: 12px;
            line-height: 1.4;
        }

        .article-summary {
            color: var(--muted);
            font-size: 14px;
            line-height: 1.6;
            margin-bottom: 16px;
            flex: 1;
        }

        .article-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 12px;
            border-top: 1px solid var(--border);
        }

        .article-source {
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 600;
            color: var(--primary);
            font-size: 12px;
        }

        .article-time {
            color: var(--muted);
            font-size: 12px;
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-header {
            padding: 24px;
            border-bottom: 1px solid var(--border);
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .modal-description {
            color: var(--muted);
            font-size: 14px;
        }

        .modal-body {
            padding: 24px;
        }

        .modal-close {
            position: absolute;
            top: 16px;
            right: 16px;
            background: transparent;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--muted);
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
        }

        .modal-close:hover {
            background: #f8fafc;
        }

        /* Form */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 8px;
            color: var(--foreground);
        }

        .form-input, .form-select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-error {
            color: var(--destructive);
            font-size: 12px;
            margin-top: 4px;
        }

        /* Sources List */
        .sources-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .source-item {
            display: flex;
            align-items: center;
            justify-between;
            padding: 16px;
            border: 1px solid var(--border);
            border-radius: 8px;
            transition: all 0.2s;
        }

        .source-item:hover {
            border-color: var(--primary);
            background: #f8fafc;
        }

        .source-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .source-flag {
            width: 24px;
            height: 18px;
            object-fit: contain;
        }

        .source-details {
            flex: 1;
        }

        .source-name-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }

        .source-name {
            font-weight: 600;
            font-size: 14px;
        }

        .source-badge {
            font-size: 10px;
            font-weight: 700;
            background: rgba(59, 130, 246, 0.1);
            color: var(--primary);
            padding: 2px 6px;
            border-radius: 4px;
            text-transform: uppercase;
        }

        .source-url {
            font-size: 12px;
            color: var(--muted);
        }

        .source-actions {
            display: flex;
            gap: 4px;
        }

        /* Toast */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .toast {
            background: white;
            border-radius: 8px;
            padding: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            min-width: 300px;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .toast-title {
            font-weight: 700;
            margin-bottom: 4px;
        }

        .toast-description {
            font-size: 14px;
            color: var(--muted);
        }

        .toast.success .toast-title { color: var(--success); }
        .toast.error .toast-title { color: var(--destructive); }

        /* Loading */
        .loading {
            text-align: center;
            padding: 60px 20px;
        }

        .spinner {
            border: 4px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Empty */
        .empty-state {
            background: white;
            border-radius: 16px;
            padding: 60px 40px;
            text-align: center;
        }

        .empty-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: 20px;
            margin-bottom: 12px;
        }

        .empty-state p {
            color: var(--muted);
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-top: 32px;
        }

        .page-info {
            padding: 10px 20px;
            border-radius: 8px;
            background: white;
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .articles-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="toast-container" id="toastContainer"></div>

    <div class="container">
        <div class="header">
            <div class="header-left">
                <div class="header-title">
                    <span style="font-size: 40px;">üì∞</span>
                    <h1>Tech Digest</h1>
                </div>
                <p class="subtitle">Not√≠cias de tecnologia em tempo real - Python/FastAPI Edition</p>
            </div>
            <div class="header-actions">
                <button class="btn" id="refreshBtn" onclick="refreshNews()">
                    <span>üîÑ</span>
                    <span>Atualizar</span>
                </button>
                <button class="btn btn-secondary" onclick="openSourcesModal()">
                    <span>‚öôÔ∏è</span>
                    <span>Fontes</span>
                </button>
            </div>
        </div>

        <div class="info-bar" id="infoBar"></div>
        <div id="content"></div>
        <div class="pagination" id="pagination" style="display: none;"></div>
    </div>

    <!-- Sources Modal -->
    <div class="modal-overlay" id="sourcesModal" onclick="closeModalOnBackdrop(event, 'sourcesModal')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <button class="modal-close" onclick="closeSourcesModal()">√ó</button>
            <div class="modal-header">
                <h2 class="modal-title">Gerenciar Fontes de Not√≠cias</h2>
                <p class="modal-description">Adicione ou remova fontes de onde as not√≠cias s√£o coletadas.</p>
            </div>
            <div class="modal-body">
                <!-- Add Source Form -->
                <div class="form-section" style="margin-bottom: 32px;">
                    <h3 style="font-size: 14px; font-weight: 700; margin-bottom: 16px;">Adicionar Nova Fonte</h3>

                    <div class="form-group">
                        <label class="form-label">Nome da Fonte</label>
                        <input type="text" class="form-input" id="newSourceName" placeholder="Ex: TechCrunch">
                    </div>

                    <div class="form-group">
                        <label class="form-label">URL</label>
                        <input type="url" class="form-input" id="newSourceUrl" placeholder="https://...">
                        <div class="form-error" id="urlError" style="display: none;"></div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Pa√≠s</label>
                        <select class="form-select" id="newSourceCountry">
                            <option value="">Selecione o pa√≠s</option>
                        </select>
                    </div>

                    <button class="btn" onclick="addSource()" style="width: 100%;">
                        <span>+</span>
                        <span>Adicionar Fonte</span>
                    </button>
                </div>

                <!-- Sources List -->
                <div class="form-section">
                    <h3 style="font-size: 14px; font-weight: 700; margin-bottom: 16px;">Fontes Atuais</h3>
                    <div class="sources-list" id="sourcesList"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Article Modal -->
    <div class="modal-overlay" id="articleModal" onclick="closeModalOnBackdrop(event, 'articleModal')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <button class="modal-close" onclick="closeArticleModal()">√ó</button>
            <img id="articleImage" style="width: 100%; height: 300px; object-fit: cover; display: none;">
            <div class="modal-header">
                <h2 class="modal-title" id="articleTitle"></h2>
                <p class="modal-description" id="articleMeta"></p>
            </div>
            <div class="modal-body">
                <p id="articleSummary" style="margin-bottom: 20px; line-height: 1.8;"></p>
                <a id="articleLink" class="btn" target="_blank">Ler not√≠cia completa ‚Üí</a>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:8000/api';
        let currentPage = 1;
        let sources = [];

        const countries = [
            { code: 'BR', name: 'Brasil', flagUrl: 'https://flagcdn.com/24x18/br.png' },
            { code: 'US', name: 'Estados Unidos', flagUrl: 'https://flagcdn.com/24x18/us.png' },
            { code: 'UK', name: 'Reino Unido', flagUrl: 'https://flagcdn.com/24x18/gb.png' },
            { code: 'FR', name: 'Fran√ßa', flagUrl: 'https://flagcdn.com/24x18/fr.png' },
            { code: 'DE', name: 'Alemanha', flagUrl: 'https://flagcdn.com/24x18/de.png' },
            { code: 'ES', name: 'Espanha', flagUrl: 'https://flagcdn.com/24x18/es.png' },
            { code: 'IN', name: '√çndia', flagUrl: 'https://flagcdn.com/24x18/in.png' },
            { code: 'JP', name: 'Jap√£o', flagUrl: 'https://flagcdn.com/24x18/jp.png' },
            { code: 'CN', name: 'China', flagUrl: 'https://flagcdn.com/24x18/cn.png' },
            { code: 'CA', name: 'Canad√°', flagUrl: 'https://flagcdn.com/24x18/ca.png' },
            { code: 'AU', name: 'Austr√°lia', flagUrl: 'https://flagcdn.com/24x18/au.png' },
            { code: 'INT', name: 'Internacional', flagUrl: 'https://flagcdn.com/24x18/un.png' }
        ];

        function showToast(title, description, type = 'success') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <div class="toast-title">${title}</div>
                <div class="toast-description">${description}</div>
            `;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        }

        function getFlag(countryCode) {
            const country = countries.find(c => c.code === countryCode);
            return country ? `<img src="${country.flagUrl}" class="source-flag">` : 'üåê';
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diff = Math.floor((now - date) / 1000);
            if (diff < 60) return 'agora';
            if (diff < 3600) return `h√° ${Math.floor(diff / 60)} min`;
            if (diff < 86400) return `h√° ${Math.floor(diff / 3600)}h`;
            return date.toLocaleDateString('pt-BR');
        }

        async function refreshNews() {
            const btn = document.getElementById('refreshBtn');
            const content = document.getElementById('content');
            btn.disabled = true;

            try {
                content.innerHTML = '<div class="loading"><div class="spinner"></div><p>Buscando not√≠cias novas...</p></div>';

                // Dispara o scraping de not√≠cias
                await fetch(`${API_URL}/scraper/fetch`, { method: 'POST' });

                // Aguarda 3 segundos para o scraping come√ßar a salvar
                await new Promise(resolve => setTimeout(resolve, 3000));

                // Busca os artigos atualizados
                await fetchArticles(1);

                showToast('Not√≠cias atualizadas!', 'success');
            } catch (e) {
                content.innerHTML = `<div class="empty-state"><div class="empty-icon">‚ö†Ô∏è</div><h3>Erro</h3><p>${e.message}</p></div>`;
                showToast('Erro ao atualizar not√≠cias', 'error');
            } finally {
                btn.disabled = false;
            }
        }

        async function fetchArticles(page = 1) {
            const btn = document.getElementById('refreshBtn');
            const content = document.getElementById('content');

            // S√≥ desabilita o bot√£o se n√£o estiver chamando via refreshNews
            const wasDisabled = btn.disabled;
            if (!wasDisabled) {
                btn.disabled = true;
            }

            if (page === 1) {
                content.innerHTML = '<div class="loading"><div class="spinner"></div><p>Carregando...</p></div>';
            }

            try {
                const res = await fetch(`${API_URL}/articles?page=${page}&limit=20`);
                const data = await res.json();
                currentPage = page;

                document.getElementById('infoBar').innerHTML =
                    `Exibindo <strong>${data.articles.length}</strong> de <strong>${data.pagination.total}</strong> not√≠cias`;

                if (data.articles.length > 0) {
                    content.innerHTML = '<div class="articles-grid">' +
                        data.articles.map(a => `
                            <div class="article-card" onclick='openArticle(${JSON.stringify(a).replace(/'/g, "&#39;")})'>
                                ${a.image_url ? `<img class="article-image" src="${a.image_url}">` : '<div class="article-image"></div>'}
                                <div class="article-content">
                                    <h3 class="article-title">${a.title}</h3>
                                    <p class="article-summary">${a.summary || 'Clique para ver mais...'}</p>
                                    <div class="article-footer">
                                        <span class="article-source">${getFlag(a.country_code)} ${a.source_name}</span>
                                        <span class="article-time">${formatDate(a.published_at)}</span>
                                    </div>
                                </div>
                            </div>
                        `).join('') + '</div>';

                    if (data.pagination.pages > 1) {
                        document.getElementById('pagination').style.display = 'flex';
                        document.getElementById('pagination').innerHTML = `
                            <button class="btn btn-secondary btn-sm" onclick="fetchArticles(${page - 1})" ${page === 1 ? 'disabled' : ''}>‚Üê Anterior</button>
                            <div class="page-info">P√°gina ${page} de ${data.pagination.pages}</div>
                            <button class="btn btn-secondary btn-sm" onclick="fetchArticles(${page + 1})" ${page === data.pagination.pages ? 'disabled' : ''}>Pr√≥xima ‚Üí</button>
                        `;
                    }
                } else {
                    content.innerHTML = '<div class="empty-state"><div class="empty-icon">üìÑ</div><h3>Nenhuma not√≠cia</h3><p>Clique em Atualizar</p></div>';
                }
            } catch (e) {
                content.innerHTML = `<div class="empty-state"><div class="empty-icon">‚ö†Ô∏è</div><h3>Erro</h3><p>${e.message}</p></div>`;
            } finally {
                // S√≥ habilita se foi desabilitado por esta fun√ß√£o
                if (!wasDisabled) {
                    btn.disabled = false;
                }
            }
        }

        function openArticle(article) {
            const modal = document.getElementById('articleModal');
            const img = document.getElementById('articleImage');
            if (article.image_url) {
                img.src = article.image_url;
                img.style.display = 'block';
            } else {
                img.style.display = 'none';
            }
            document.getElementById('articleTitle').textContent = article.title;
            document.getElementById('articleMeta').textContent = `${article.source_name} ‚Ä¢ ${formatDate(article.published_at)}`;
            document.getElementById('articleSummary').textContent = article.summary || article.title;
            document.getElementById('articleLink').href = article.url;
            modal.classList.add('active');
        }

        function closeArticleModal() {
            document.getElementById('articleModal').classList.remove('active');
        }

        async function openSourcesModal() {
            await loadSources();
            document.getElementById('sourcesModal').classList.add('active');
        }

        function closeSourcesModal() {
            document.getElementById('sourcesModal').classList.remove('active');
        }

        function closeModalOnBackdrop(e, modalId) {
            if (e.target.id === modalId) {
                document.getElementById(modalId).classList.remove('active');
            }
        }

        async function loadSources() {
            try {
                const res = await fetch(`${API_URL}/sources?active_only=false`);
                const data = await res.json();
                sources = data.sources || [];
                renderSources();
                renderCountrySelect();
            } catch (e) {
                showToast('Erro', 'N√£o foi poss√≠vel carregar fontes', 'error');
            }
        }

        function renderCountrySelect() {
            const select = document.getElementById('newSourceCountry');
            select.innerHTML = '<option value="">Selecione o pa√≠s</option>' +
                countries.map(c => `<option value="${c.code}">${c.name}</option>`).join('');
        }

        function renderSources() {
            const list = document.getElementById('sourcesList');
            if (sources.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: var(--muted); padding: 20px;">Nenhuma fonte cadastrada</p>';
                return;
            }

            list.innerHTML = sources.map(s => {
                const country = countries.find(c => c.code === s.country_code);
                return `
                    <div class="source-item">
                        <div class="source-info">
                            ${country ? `<img src="${country.flagUrl}" class="source-flag">` : 'üåê'}
                            <div class="source-details">
                                <div class="source-name-row">
                                    <span class="source-name">${s.name}</span>
                                    ${country ? `<span class="source-badge">${country.code}</span>` : ''}
                                </div>
                                <div class="source-url">${s.url}</div>
                            </div>
                        </div>
                        <div class="source-actions">
                            <button class="btn btn-ghost btn-sm" onclick="deleteSource('${s.id}', '${s.name}')">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function addSource() {
            const name = document.getElementById('newSourceName').value.trim();
            const url = document.getElementById('newSourceUrl').value.trim();
            const country = document.getElementById('newSourceCountry').value;

            if (!name || !url) {
                showToast('Campos obrigat√≥rios', 'Preencha nome e URL', 'error');
                return;
            }

            try {
                new URL(url);
            } catch {
                document.getElementById('urlError').textContent = 'URL inv√°lida. Use: https://exemplo.com';
                document.getElementById('urlError').style.display = 'block';
                return;
            }

            try {
                const res = await fetch(`${API_URL}/sources`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, url, country_code: country || null })
                });

                if (res.ok) {
                    showToast('Fonte adicionada!', `${name} foi adicionada com sucesso.`);
                    document.getElementById('newSourceName').value = '';
                    document.getElementById('newSourceUrl').value = '';
                    document.getElementById('newSourceCountry').value = '';
                    document.getElementById('urlError').style.display = 'none';
                    await loadSources();
                } else {
                    throw new Error();
                }
            } catch {
                showToast('Erro', 'N√£o foi poss√≠vel adicionar fonte', 'error');
            }
        }

        async function deleteSource(id, name) {
            if (!confirm(`Remover "${name}"?`)) return;

            try {
                const res = await fetch(`${API_URL}/sources/${id}`, { method: 'DELETE' });
                if (res.ok) {
                    showToast('Fonte removida!', `${name} foi removida com sucesso.`);
                    await loadSources();
                } else {
                    throw new Error();
                }
            } catch {
                showToast('Erro', 'N√£o foi poss√≠vel remover fonte', 'error');
            }
        }

        document.addEventListener('keydown', e => {
            if (e.key === 'Escape') {
                closeArticleModal();
                closeSourcesModal();
            }
        });

        fetchArticles();
    </script>
</body>
</html>
